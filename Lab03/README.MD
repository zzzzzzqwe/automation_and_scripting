# Лабораторная работа 3
# Студент: Gachayev Dmitrii, I2302
# Дата выполнения: 11.10.2025
# Цель
Научиться настраивать планировщик задач (cron) для автоматизации выполнения скриптов.

---

# Сборка и запуск контейнера с cron

Для того чтобы запустить контейнер с cron необходимо клонировать репозиторий и перейти в папку с проектом:

```bash
cd Lab03
```

И собрать и запустить контейнер
```bash
docker compose up -d --build
```

Так как работа основана на 2 лабораторной работе, скрипт взаимодействует с контейнером из прошлой работы, так что его тоже необходимо запустить:
```
cd lab02prep

docker-compose up --build
```

# Проверка, что cron задачи выполняются и вывод записывается в файл /var/log/cron.log

Для того чтобы проверить что задачи выполняются были созданы тестовые задачи для проверки:
```bash
# Для теста, каждую минуту
# * * * * * root . /etc/environment && DATE=$(date -d "yesterday" +\%F) && python /app/currency_exchange_rate.py --from MDL --to EUR --date "$DATE" --key "$API_KEY" --api-url "$API_URL" >> /var/log/cron.log 2>&1

# Для теста, каждую минуту
# DAYS=6
# * * * * * root . /etc/environment && START=$(date -d 'last week monday' +\%F) && for i in $(seq 0 $((DAYS))); do D=$(date -d "$START +$i day" +\%F); echo "[WEEKLY_TEST] $D"; python /app/currency_exchange_rate.py --from MDL --to USD --date "$D" --key "$API_KEY" --api-url "$API_URL"; done >> /var/log/cron.log 2>&1
```

Первая иммитирует задачу:

- "Ежедневно в 6:00 утра получение курса MDL к EUR за предыдущий день."

Вторая иммитирует задачу:

- "Еженедельно в пятницу в 17:00 получение курса MDL к USD за предыдущую неделю."
 
 Количество дней для вывода курса контроллируется переменной `DAYS`.

 Чтобы провести тесты достаточно разкомментировать строки, перезапустить контейнер и наблюдать за созданием файлов в папке `data` а так же за файлом логов, который можно просмотреть с помощью команды:
 ```bash
docker compose logs -f
 ```

 # Структура проекта и назначение файлов

```
 Lab03/
├─ lab02prep
├─ currency_exchange_rate.py
├─ cronjob
├─ entrypoint.sh
├─ Dockerfile
├─ docker-compose.yml
├─ data/
└─ cron.log
```

- `lab02prep` — материалы прошлой лабораторной. В текущем проекте используется как источник данных, к которому обращается cron-контейнер.

- `currency_exchange_rate.py` — клиентский Python-скрипт. По аргументам формирует дату, запрашивает курс у API_URL с API_KEY и сохраняет результат в JSON в каталоге data, печатая статус в вывод.

- `cronjob` — файл расписаний для /etc/cron.d. Задает окружение (включая HOME=/app) и две задачи (без учёта тестовых): ежедневно в 06:00 MDL-EUR за вчера и по пятницам в 17:00 MDL-USD за прошлую неделю; вывод перенаправлен в /var/log/cron.log.

- `entrypoint.sh` — стартовый скрипт контейнера. Экспортирует переменные в /etc/environment, создает /var/log/cron.log, запускает tail для логов в фоне и cron -f как основной процесс.

- `Dockerfile` — сборка образа. Ставит cron/tzdata и Python-зависимости, копирует внутрь скрипт, cronjob и entrypoint, правит права и перевод строк, настраивает точку входа.

- `docker-compose.yml` — описывает один сервис lab03-cron, который собирается из текущей директории и запускается под именем контейнера lab03-cron. В контейнер передаются переменные окружения API_URL, API_KEY и TZ. Монтируются тома: ./data в /app/data для сохранения JSON-файлов и ./cron.log в /var/log/cron.log для логов cron.

- `data/` — хостовый каталог для артефактов работы скрипта. Содержит сохраняемые по расписанию JSON-файлы и переживает перезапуски контейнера.

- `cron.log` — хостовый файл логов cron. В нем виден вывод всех задач и сообщения скрипта для отладки.

# Пример использования
После запуска скрипт автоматически сохраняем в `data` данные о курсе в соответствии с задачами, но так же можно использовать его раскомментировав строки в `cronjob` и запустив контейнер. В течении минуты в папке `data` появятся json файлы с информацией о курсе.

# Вывод
В ходе работы собран и запущен контейнер, в котором cron по расписанию вызывает Python-скрипт для получения курсов валют и сохраняет их в виде JSON в общий каталог data, а весь вывод задач пишется в файл cron.log.